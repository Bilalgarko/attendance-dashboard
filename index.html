<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Class Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #134e1a 0%, #e9f5e1 100%);
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
        }
        .container { 
            max-width: 400px; 
            margin: 40px auto; 
            background: #fff;
            padding: 30px 40px 40px 40px; 
            border-radius: 16px; 
            box-shadow: 0 4px 24px rgba(19, 78, 26, 0.18), 0 0px 0px #134e1a;
            border: 2px solid #1c6e34;
        }
        .wide-container {
            max-width: 900px;
        }
        h2 { text-align: center; color: #134e1a; }
        label { display: block; margin-top: 18px; margin-bottom: 6px; color: #134e1a; font-weight: 500;}
        input, select { 
            width: 100%; 
            padding: 9px; 
            border: 1.5px solid #1c6e34; 
            border-radius: 5px; 
            background: #e9f5e1;
            color: #134e1a;
        }
        input:focus, select:focus {
            outline: 2px solid #1c6e34;
            background: #d8f3c5;
        }
        button { 
            width: 100%; 
            background: #134e1a; 
            color: #fff; 
            border: none; 
            padding: 12px; 
            border-radius: 5px; 
            margin-top: 18px; 
            font-size: 16px; 
            cursor: pointer; 
            box-shadow: 0 2px 6px rgba(19, 78, 26, 0.12);
            transition: background 0.2s;
        }
        button:hover, .profile-edit-btn:hover { background: #208b3a;}
        .hidden { display: none; }
        .success { color: #178a42; text-align: center; margin-top: 20px;}
        .error { color: #ac2626; text-align: center; margin-top: 10px;}
        .attendance-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            background: #f3fcf7;
        }
        .attendance-table th, .attendance-table td { 
            padding: 8px; 
            border: 1.2px solid #1c6e34; 
            text-align: center;
        }
        .attendance-table th { background: #daf5d7; color: #134e1a;}
        .dashboard-links { text-align: center; margin-bottom: 20px;}
        .dashboard-links a { margin: 0 7px; color: #208b3a; text-decoration: underline; cursor: pointer;}
        .admin-section { 
            background: #eafaea; 
            border: 1.5px solid #178a42; 
            padding: 18px; 
            border-radius: 12px; 
            margin-top: 30px;
        }
        .profile-section {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            background: #daf5d7;
            border-radius: 11px;
            padding: 12px;
            border: 1px solid #1c6e34;
        }
        .profile-photo {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 50%;
            border: 2.5px solid #208b3a;
            margin-right: 16px;
            background: #e9f5e1;
        }
        .profile-edit-btn {
            background: #208b3a;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
            margin-left: 10px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(19,78,26,0.08);
            transition: background 0.2s;
        }
        .profile-edit-btn:active {
            background: #155d27;
        }
        .profile-edit-form input[type="file"] {
            padding: 0;
        }
        .profile-edit-form input,
        .profile-edit-form button {
            margin-top: 8px;
        }
        .profile-info-fields {
            flex: 1;
        }
        ::-webkit-scrollbar {width: 9px;}
        ::-webkit-scrollbar-thumb {background: #1c6e34; border-radius: 5px;}
        ::-webkit-scrollbar-track {background: #daf5d7;}
    </style>
</head>
<body>
<!-- Attendance for All (Visible to Everyone) -->
<div class="container wide-container hidden" id="allAttendanceContainer">
    <h2>All Students' Attendance Records</h2>
    <div class="dashboard-links" style="margin-bottom:8px;">
        <button id="printAttendanceBtn" style="width:auto;background:#208b3a;color:#fff;padding:8px 18px;margin-bottom:8px;border-radius:6px;font-size:15px;border: none;cursor:pointer;box-shadow:0 2px 6px rgba(19,78,26,0.10);">
            Print All Attendance Report
        </button>
    </div>
    <div id="allAttendanceRecords"></div>
    <div class="dashboard-links">
        <a id="backToDashboard" href="#">Back to Dashboard</a>
        <a id="logoutAllAttendance" href="#">Logout</a>
    </div>
</div>

<!-- Registration Page -->
<div class="container" id="registerContainer">
    <h2>Create Your Profile</h2>
    <form id="registerForm" autocomplete="off">
        <label for="fullName">Full Name <span style="color:red">*</span></label>
        <input type="text" id="regFullName" name="fullName" required autocomplete="off">

        <label for="regNumber">Registration Number <span style="color:red">*</span></label>
        <input type="text" id="regRegNumber" name="regNumber" required autocomplete="off">

        <label for="course">Course of Study <span style="color:red">*</span></label>
        <input type="text" id="regCourse" name="course" required autocomplete="off">

        <label for="fieldOfStudy">Field of Study <span style="color:red">*</span></label>
        <input type="text" id="regField" name="fieldOfStudy" required autocomplete="off">

        <label for="regPassword">Create Password <span style="color:red">*</span></label>
        <input type="password" id="regPassword" name="password" required minlength="6" autocomplete="new-password">

        <label for="regConfirmPassword">Confirm Password <span style="color:red">*</span></label>
        <input type="password" id="regConfirmPassword" name="confirmPassword" required minlength="6" autocomplete="new-password">

        <div class="error hidden" id="registerError"></div>
        <button type="submit">Create Profile</button>
        <div class="dashboard-links">
            Already have a profile? <a id="toLogin">Login</a>
        </div>
    </form>
</div>

<!-- Login Page -->
<div class="container hidden" id="loginContainer">
    <h2>Login</h2>
    <form id="loginForm" autocomplete="off">
        <label for="loginRegNumber">Registration Number <span style="color:red">*</span></label>
        <input type="text" id="loginRegNumber" name="loginRegNumber" required autocomplete="off">

        <label for="loginPassword">Password <span style="color:red">*</span></label>
        <input type="password" id="loginPassword" name="loginPassword" required autocomplete="current-password">

        <div class="error hidden" id="loginError"></div>
        <button type="submit">Login</button>
        <div class="dashboard-links" style="margin-top:12px;">
            <span>No profile? <a id="toRegister">Create one</a></span><br>
            <span><a id="toForgotPassword" style="color:#208b3a;">Forgot Password?</a></span>
        </div>
    </form>
</div>

<!-- Forgot Password Page -->
<div class="container hidden" id="forgotPasswordContainer">
    <h2>Reset Password</h2>
    <form id="forgotPasswordForm" autocomplete="off">
        <label for="fpRegNumber">Registration Number <span style="color:red">*</span></label>
        <input type="text" id="fpRegNumber" required autocomplete="off">

        <label for="fpLastAttendance">Last Day of Attendance (format: MM/DD/YYYY or DD/MM/YYYY) <span style="color:red">*</span></label>
        <input type="text" id="fpLastAttendance" placeholder="e.g., 09/17/2025" required autocomplete="off">

        <label for="fpNewPassword">New Password <span style="color:red">*</span></label>
        <input type="password" id="fpNewPassword" required minlength="6" autocomplete="new-password">

        <label for="fpConfirmPassword">Confirm New Password <span style="color:red">*</span></label>
        <input type="password" id="fpConfirmPassword" required minlength="6" autocomplete="new-password">

        <div class="error hidden" id="forgotPasswordError"></div>
        <div class="success hidden" id="forgotPasswordSuccess"></div>
        <button type="submit">Reset Password</button>
        <div class="dashboard-links">
            <a id="fpBackToLogin">Back to Login</a>
        </div>
    </form>
</div>

<!-- Dashboard Page -->
<div class="container hidden" id="dashboardContainer">
    <div class="profile-section">
        <img id="profilePhoto" class="profile-photo" src="https://ui-avatars.com/api/?name=User" alt="Profile Photo">
        <div class="profile-info-fields">
            <span style="font-size:1.3em;font-weight:bold;color:#134e1a;" id="userName"></span>
            <br>
            <span id="userCourse"></span> | 
            <span id="userField"></span>
            <br>
            <span style="font-size:.96em;color:#178a42;">Reg No: <span id="userReg"></span></span>
        </div>
        <button class="profile-edit-btn" id="editProfileBtn" title="Edit Profile">Edit</button>
    </div>
    <form class="profile-edit-form hidden" id="profileEditForm" enctype="multipart/form-data" autocomplete="off">
        <label for="editFullName">Full Name</label>
        <input type="text" id="editFullName" required>
        <label for="editCourse">Course of Study</label>
        <input type="text" id="editCourse" required>
        <label for="editField">Field of Study</label>
        <input type="text" id="editField" required>
        <label for="editProfilePhoto">Profile Photo</label>
        <input type="file" id="editProfilePhoto" accept="image/*">
        <div class="error hidden" id="editProfileError"></div>
        <button type="submit" style="background:#134e1a;color:#fff;">Save Changes</button>
        <button type="button" id="cancelEditProfile" style="background:#e9f5e1;color:#178a42;">Cancel</button>
    </form>
    <div class="dashboard-links">
        <a id="markAttendanceLink" href="#">Mark Attendance</a> | 
        <a id="viewAttendanceLink" href="#">My Attendance</a> | 
        <a id="viewAllAttendanceLink" href="#">All Attendance</a> | 
        <a id="logoutBtn" href="#">Logout</a>
    </div>
    <div id="dashboardSection"></div>
</div>

<script>
    // ... (existing JS code above remains the same) ...

    // Profile photo utility
    function readAndPreviewPhoto(file, callback) {
        if (!file) return callback('');
        const reader = new FileReader();
        reader.onload = function(e) {
            callback(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    // Registration
    const registerContainer = document.getElementById('registerContainer');
    const registerForm = document.getElementById('registerForm');
    const registerError = document.getElementById('registerError');
    const toLogin = document.getElementById('toLogin');

    toLogin.onclick = function() {
        registerContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const fullName = document.getElementById('regFullName').value.trim();
        const regNumber = document.getElementById('regRegNumber').value.trim();
        const course = document.getElementById('regCourse').value.trim();
        const field = document.getElementById('regField').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;

        if(!fullName || !regNumber || !course || !field || !password || !confirmPassword) {
            registerError.textContent = "All fields are required.";
            registerError.classList.remove('hidden');
            return;
        }

        if(password !== confirmPassword) {
            registerError.textContent = "Passwords do not match.";
            registerError.classList.remove('hidden');
            return;
        }
        if(password.length < 6) {
            registerError.textContent = "Password must be at least 6 characters.";
            registerError.classList.remove('hidden');
            return;
        }

        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        if(users[regNumber]) {
            registerError.textContent = "Registration number already exists.";
            registerError.classList.remove('hidden');
            return;
        }
        users[regNumber] = {
            fullName,
            regNumber,
            course,
            field,
            password,
            profilePhoto: "",
            attendance: []
        };
        localStorage.setItem('attendanceUsers', JSON.stringify(users));
        localStorage.setItem('attendanceCurrentUser', regNumber);

        registerForm.reset();
        showDashboard(users[regNumber]);
    });

    // Login
    const loginContainer = document.getElementById('loginContainer');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const toRegister = document.getElementById('toRegister');

    toRegister.onclick = function() {
        loginContainer.classList.add('hidden');
        registerContainer.classList.remove('hidden');
    };

    // Forgot Password
    const toForgotPassword = document.getElementById('toForgotPassword');
    const forgotPasswordContainer = document.getElementById('forgotPasswordContainer');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const fpBackToLogin = document.getElementById('fpBackToLogin');
    const forgotPasswordError = document.getElementById('forgotPasswordError');
    const forgotPasswordSuccess = document.getElementById('forgotPasswordSuccess');

    toForgotPassword.onclick = function() {
        loginContainer.classList.add('hidden');
        forgotPasswordContainer.classList.remove('hidden');
        forgotPasswordForm.reset();
        forgotPasswordError.classList.add('hidden');
        forgotPasswordSuccess.classList.add('hidden');
    };
    fpBackToLogin.onclick = function() {
        forgotPasswordContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    forgotPasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        forgotPasswordError.classList.add('hidden');
        forgotPasswordSuccess.classList.add('hidden');
        const regNumber = document.getElementById('fpRegNumber').value.trim();
        const lastAttendance = document.getElementById('fpLastAttendance').value.trim();
        const newPassword = document.getElementById('fpNewPassword').value;
        const confirmPassword = document.getElementById('fpConfirmPassword').value;

        if (!regNumber || !lastAttendance || !newPassword || !confirmPassword) {
            forgotPasswordError.textContent = "All fields are required.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        if (newPassword !== confirmPassword) {
            forgotPasswordError.textContent = "Passwords do not match.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        if (newPassword.length < 6) {
            forgotPasswordError.textContent = "Password must be at least 6 characters.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) {
            forgotPasswordError.textContent = "Registration number not found.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        if (!user.attendance || user.attendance.length === 0) {
            forgotPasswordError.textContent = "No attendance records found for this user.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        const lastAttendanceSanitized = lastAttendance.replace(/-/g, '/').replace(/\./g,'/').replace(/\s/g,'');
        const attendedDates = user.attendance.map(a => a.date.replace(/-/g, '/').replace(/\./g,'/').replace(/\s/g,''));
        const matched = attendedDates.some(d => d === lastAttendanceSanitized);
        if (!matched) {
            forgotPasswordError.textContent = "Last attendance date does not match our records.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        user.password = newPassword;
        users[regNumber] = user;
        localStorage.setItem('attendanceUsers', JSON.stringify(users));
        forgotPasswordSuccess.textContent = "Password reset successful! You can now login with your new password.";
        forgotPasswordSuccess.classList.remove('hidden');
    });

    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const regNumber = document.getElementById('loginRegNumber').value.trim();
        const password = document.getElementById('loginPassword').value;

        if(regNumber === CLASS_MASTER_REG && password === CLASS_MASTER_PASS) {
            localStorage.setItem('attendanceCurrentUser', CLASS_MASTER_REG);
            showAllAttendance();
            return;
        }

        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        if(users[regNumber] && users[regNumber].password === password) {
            localStorage.setItem('attendanceCurrentUser', regNumber);
            showDashboard(users[regNumber]);
        } else {
            loginError.textContent = "Invalid registration number or password.";
            loginError.classList.remove('hidden');
        }
    });

    // Dashboard
    const dashboardContainer = document.getElementById('dashboardContainer');
    const userName = document.getElementById('userName');
    const userReg = document.getElementById('userReg');
    const userCourse = document.getElementById('userCourse');
    const userField = document.getElementById('userField');
    const profilePhoto = document.getElementById('profilePhoto');
    const dashboardSection = document.getElementById('dashboardSection');
    const markAttendanceLink = document.getElementById('markAttendanceLink');
    const viewAttendanceLink = document.getElementById('viewAttendanceLink');
    const viewAllAttendanceLink = document.getElementById('viewAllAttendanceLink');
    const logoutBtn = document.getElementById('logoutBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const profileEditForm = document.getElementById('profileEditForm');
    const editFullName = document.getElementById('editFullName');
    const editCourse = document.getElementById('editCourse');
    const editField = document.getElementById('editField');
    const editProfilePhoto = document.getElementById('editProfilePhoto');
    const editProfileError = document.getElementById('editProfileError');
    const cancelEditProfile = document.getElementById('cancelEditProfile');

    let currentProfilePhotoURL = "";

    function updateProfileUI(user) {
        userName.textContent = user.fullName;
        userReg.textContent = user.regNumber;
        userCourse.textContent = user.course;
        userField.textContent = user.field || '';
        let url = user.profilePhoto;
        if (url) {
            profilePhoto.src = url;
        } else {
            profilePhoto.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}`;
        }
    }

    markAttendanceLink.onclick = function() {
        dashboardSection.innerHTML = `
            <form id="attendanceForm">
                <button type="submit" id="markAttendanceBtn">Mark Attendance</button>
            </form>
            <div class="success hidden" id="attendanceSuccess">Attendance recorded successfully!</div>
            <div class="error hidden" id="attendanceError"></div>
        `;
        document.getElementById('attendanceForm').onsubmit = handleAttendance;
    };

    // My Attendance Print Button
    function insertPrintMyAttendanceButton(myAttendanceTable, user) {
        if(document.getElementById('printMyAttendanceBtn')) return;
        const btn = document.createElement('button');
        btn.id = "printMyAttendanceBtn";
        btn.textContent = "Print My Attendance";
        btn.style.cssText = "width:auto;background:#208b3a;color:#fff;padding:8px 18px;margin-bottom:12px;border-radius:6px;font-size:15px;border: none;cursor:pointer;box-shadow:0 2px 6px rgba(19,78,26,0.10);display:block;margin-left:auto;margin-right:auto;";
        btn.onclick = function() {
            const printWindow = window.open('', '', 'width=800,height=650');
            printWindow.document.write(`
                <html>
                <head>
                    <title>My Attendance Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 36px; color: #134e1a;}
                        h2 { text-align: center; color: #134e1a;}
                        .attendance-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #f3fcf7;}
                        .attendance-table th, .attendance-table td { padding: 8px; border: 1.2px solid #1c6e34; text-align: center;}
                        .attendance-table th { background: #daf5d7; color: #134e1a;}
                        .profile-photo { width: 48px; height: 48px; object-fit: cover; border-radius: 50%; border: 2.5px solid #208b3a; margin-bottom: 8px;}
                    </style>
                </head>
                <body>
                    <h2>Attendance Report for ${user.fullName} (${user.regNumber})</h2>
                    <div style="text-align:center;">
                        <img class="profile-photo" src="${user.profilePhoto ? user.profilePhoto : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}`}" alt="Profile Photo">
                        <div style="font-size:1.2em;margin-bottom:4px;">${user.course} | ${user.field}</div>
                    </div>
                    ${myAttendanceTable.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        };
        myAttendanceTable.parentNode.insertBefore(btn, myAttendanceTable);
    }

    viewAttendanceLink.onclick = function() {
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if(user) {
            let table = `<table class="attendance-table" id="myAttendanceTable">
                <tr><th>#</th><th>Date</th><th>Time</th></tr>`;
            if(user.attendance.length === 0) {
                table += "<tr><td colspan='3'>No attendance records.</td></tr>";
            } else {
                user.attendance.forEach((a, i) => {
                    table += `<tr>
                        <td>${i+1}</td>
                        <td>${a.date}</td>
                        <td>${a.time}</td>
                    </tr>`;
                });
            }
            table += "</table>";
            dashboardSection.innerHTML = `<h3>My Attendance</h3>${table}`;
            const myAttendanceTable = document.getElementById('myAttendanceTable');
            insertPrintMyAttendanceButton(myAttendanceTable, user);
        }
    };

    viewAllAttendanceLink.onclick = function() {
        dashboardContainer.classList.add('hidden');
        showAllAttendance();
    };

    logoutBtn.onclick = function() {
        localStorage.removeItem('attendanceCurrentUser');
        dashboardContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    function handleAttendance(e) {
        e.preventDefault();
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        const attendanceSuccess = document.getElementById('attendanceSuccess');
        const attendanceError = document.getElementById('attendanceError');
        attendanceSuccess.classList.add('hidden');
        attendanceError.classList.add('hidden');

        if(user) {
            const now = new Date();
            const date = now.toLocaleDateString();
            const alreadyMarked = user.attendance.some(entry => entry.date === date);
            if(alreadyMarked) {
                attendanceError.textContent = "You have already marked attendance for today.";
                attendanceError.classList.remove('hidden');
                return;
            }
            const time = now.toLocaleTimeString();
            user.attendance.push({ date, time });
            users[regNumber] = user;
            localStorage.setItem('attendanceUsers', JSON.stringify(users));
            attendanceSuccess.classList.remove('hidden');
        }
    }

    function showDashboard(user) {
        registerContainer.classList.add('hidden');
        loginContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        allAttendanceContainer.classList.add('hidden');
        profileEditForm.classList.add('hidden');
        updateProfileUI(user);
        dashboardSection.innerHTML = '';
    }

    editProfileBtn.onclick = function() {
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) return;
        editFullName.value = user.fullName;
        editCourse.value = user.course;
        editField.value = user.field;
        currentProfilePhotoURL = user.profilePhoto || "";
        profileEditForm.classList.remove('hidden');
    };

    cancelEditProfile.onclick = function() {
        profileEditForm.classList.add('hidden');
        editProfileError.classList.add('hidden');
    };

    profileEditForm.onsubmit = function(e) {
        e.preventDefault();
        editProfileError.classList.add('hidden');
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) return;
        const newFullName = editFullName.value.trim();
        const newCourse = editCourse.value.trim();
        const newField = editField.value.trim();
        if (!newFullName || !newCourse || !newField) {
            editProfileError.textContent = "All fields are required.";
            editProfileError.classList.remove('hidden');
            return;
        }
        const file = editProfilePhoto.files[0];
        if (file) {
            if (file.size > 1024 * 1024) {
                editProfileError.textContent = "Profile photo must be less than 1MB.";
                editProfileError.classList.remove('hidden');
                return;
            }
            readAndPreviewPhoto(file, function(dataUrl) {
                user.profilePhoto = dataUrl;
                finishProfileEditUpdate();
            });
        } else {
            user.profilePhoto = currentProfilePhotoURL;
            finishProfileEditUpdate();
        }
        function finishProfileEditUpdate() {
            user.fullName = newFullName;
            user.course = newCourse;
            user.field = newField;
            users[regNumber] = user;
            localStorage.setItem('attendanceUsers', JSON.stringify(users));
            profileEditForm.classList.add('hidden');
            updateProfileUI(user);
        }
    };

    // All Attendance (Visible to Everyone)
    const allAttendanceContainer = document.getElementById('allAttendanceContainer');
    const allAttendanceRecords = document.getElementById('allAttendanceRecords');
    const backToDashboard = document.getElementById('backToDashboard');
    const logoutAllAttendance = document.getElementById('logoutAllAttendance');
    const printAttendanceBtn = document.getElementById('printAttendanceBtn');

    backToDashboard.onclick = function() {
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        if (regNumber && regNumber !== CLASS_MASTER_REG) {
            const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
            showDashboard(users[regNumber]);
        } else {
            allAttendanceContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
        }
    };

    logoutAllAttendance.onclick = function() {
        localStorage.removeItem('attendanceCurrentUser');
        allAttendanceContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    printAttendanceBtn.onclick = function() {
        const attendanceContent = document.getElementById('allAttendanceRecords').innerHTML;
        const printWindow = window.open('', '', 'width=1000,height=700');
        printWindow.document.write(`
            <html>
            <head>
                <title>Attendance Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 28px; color: #134e1a;}
                    h2 { text-align: center; color: #134e1a;}
                    .admin-section { background: #eafaea; border: 1.5px solid #178a42; padding: 18px; border-radius: 12px; margin-top: 30px;}
                    .attendance-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #f3fcf7;}
                    .attendance-table th, .attendance-table td { padding: 8px; border: 1.2px solid #1c6e34; text-align: center;}
                    .attendance-table th { background: #daf5d7; color: #134e1a;}
                    img { width: 36px; height: 36px; object-fit: cover; border-radius: 50%; vertical-align: middle; margin-right: 10px; border: 1.5px solid #208b3a;}
                </style>
            </head>
            <body>
                <h2>All Students' Attendance Records</h2>
                ${attendanceContent}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
        }, 500);
    };

    function showAllAttendance() {
        registerContainer.classList.add('hidden');
        loginContainer.classList.add('hidden');
        dashboardContainer.classList.add('hidden');
        allAttendanceContainer.classList.remove('hidden');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        let html = '';
        let hasAttendance = false;
        for(const reg in users) {
            const user = users[reg];
            let img = user.profilePhoto
                ? `<img src="${user.profilePhoto}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;vertical-align:middle;margin-right:10px;border:1.5px solid #208b3a;">`
                : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;vertical-align:middle;margin-right:10px;border:1.5px solid #208b3a;">`;
            html += `<div class="admin-section">
                ${img}
                <strong style="vertical-align:middle;">${user.fullName} (${user.regNumber})</strong><br>
                <em>Course: ${user.course} <br>Field: ${user.field || ''}</em>
                <table class="attendance-table" style="margin-top:10px;">
                    <tr><th>#</th><th>Date</th><th>Time</th></tr>
                    ${
                        user.attendance && user.attendance.length > 0 ?
                        user.attendance.map((a,i) => `
                            <tr>
                                <td>${i+1}</td>
                                <td>${a.date}</td>
                                <td>${a.time}</td>
                            </tr>
                        `).join('') :
                        '<tr><td colspan="3">No attendance records.</td></tr>'
                    }
                </table>
            </div>`;
            if (user.attendance && user.attendance.length > 0) hasAttendance = true;
        }
        if(!hasAttendance) html = "<p>No attendance records yet.</p>";
        allAttendanceRecords.innerHTML = html;
    }

    window.onload = function() {
        const currentUser = localStorage.getItem('attendanceCurrentUser');
        if(currentUser === CLASS_MASTER_REG) {
            showAllAttendance();
        } else if(currentUser) {
            const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
            if(users[currentUser]) {
                showDashboard(users[currentUser]);
            } else {
                localStorage.removeItem('attendanceCurrentUser');
                registerContainer.classList.remove('hidden');
            }
        } else {
            registerContainer.classList.remove('hidden');
        }
    };
</script>
</body>
</html>
