<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Class Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #134e1a 0%, #e9f5e1 100%);
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
        }
        .container { 
            max-width: 400px; 
            margin: 40px auto; 
            background: #fff;
            padding: 30px 40px 40px 40px; 
            border-radius: 16px; 
            box-shadow: 0 4px 24px rgba(19, 78, 26, 0.18), 0 0px 0px #134e1a;
            border: 2px solid #1c6e34;
        }
        .wide-container {
            max-width: 900px;
        }
        h2 { text-align: center; color: #134e1a; }
        label { display: block; margin-top: 18px; margin-bottom: 6px; color: #134e1a; font-weight: 500;}
        input, select { 
            width: 100%; 
            padding: 9px; 
            border: 1.5px solid #1c6e34; 
            border-radius: 5px; 
            background: #e9f5e1;
            color: #134e1a;
        }
        input:focus, select:focus {
            outline: 2px solid #1c6e34;
            background: #d8f3c5;
        }
        button { 
            width: 100%; 
            background: #134e1a; 
            color: #fff; 
            border: none; 
            padding: 12px; 
            border-radius: 5px; 
            margin-top: 18px; 
            font-size: 16px; 
            cursor: pointer; 
            box-shadow: 0 2px 6px rgba(19, 78, 26, 0.12);
            transition: background 0.2s;
        }
        button:hover, .profile-edit-btn:hover, .user-profile-btn:hover, .print-btn:hover { background: #208b3a;}
        .print-btn {
            width: auto;
            padding: 8px 20px;
            margin: 10px 0 0 0;
            float: right;
            font-size: 15px;
        }
        .user-profile-btn {
            width: auto;
            padding: 5px 13px;
            margin: 0 0 0 8px;
            background: #208b3a;
            color: #fff;
            border-radius: 5px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(19,78,26,0.08);
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        .hidden { display: none; }
        .success { color: #178a42; text-align: center; margin-top: 20px;}
        .error { color: #ac2626; text-align: center; margin-top: 10px;}
        .attendance-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            background: #f3fcf7;
        }
        .attendance-table th, .attendance-table td { 
            padding: 8px; 
            border: 1.2px solid #1c6e34; 
            text-align: center;
        }
        .attendance-table th { background: #daf5d7; color: #134e1a;}
        .dashboard-links { text-align: center; margin-bottom: 20px;}
        .dashboard-links a { margin: 0 7px; color: #208b3a; text-decoration: underline; cursor: pointer;}
        .admin-section { 
            background: #eafaea; 
            border: 1.5px solid #178a42; 
            padding: 18px; 
            border-radius: 12px; 
            margin-top: 30px;
        }
        .profile-section {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            background: #daf5d7;
            border-radius: 11px;
            padding: 12px;
            border: 1px solid #1c6e34;
        }
        .profile-photo {
            width: 72px;
            height: 72px;
            object-fit: cover;
            border-radius: 50%;
            border: 2.5px solid #208b3a;
            margin-right: 16px;
            background: #e9f5e1;
        }
        .profile-edit-btn {
            background: #208b3a;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
            margin-left: 10px;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(19,78,26,0.08);
            transition: background 0.2s;
        }
        .profile-edit-btn:active {
            background: #155d27;
        }
        .profile-edit-form input[type="file"] {
            padding: 0;
        }
        .profile-edit-form input,
        .profile-edit-form button {
            margin-top: 8px;
        }
        .profile-info-fields {
            flex: 1;
        }
        /* Custom scroll bar */
        ::-webkit-scrollbar {width: 9px;}
        ::-webkit-scrollbar-thumb {background: #1c6e34; border-radius: 5px;}
        ::-webkit-scrollbar-track {background: #daf5d7;}
        /* Modal Styles */
        .modal-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(19,78,26,0.12);
            z-index: 1010;
        }
        .modal-card {
            background: #fff;
            max-width: 450px;
            margin: 80px auto;
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(19,78,26,0.19);
            border: 2px solid #134e1a;
            padding: 28px 30px 24px 30px;
            z-index: 1020;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 18px;
            background: #ac2626;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 17px;
            width: 28px; height: 28px;
            cursor: pointer;
        }
        .modal-profile-photo {
            width: 70px; height: 70px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #208b3a;
            margin-bottom: 13px;
            background: #eafaea;
        }
        @media print {
            body * { visibility: hidden; }
            #attendancePrintSection, #attendancePrintSection * { visibility: visible; }
            #attendancePrintSection { position: absolute; left: 0; top: 0; width: 100vw; background: #fff; }
            .print-btn, .user-profile-btn, .dashboard-links, .profile-edit-btn, .profile-edit-form, .modal-bg, .modal-card, .modal-close-btn { display: none !important; }
        }
    </style>
</head>
<body>
<!-- Attendance for All (Visible to Everyone) -->
<div class="container wide-container hidden" id="allAttendanceContainer">
    <h2>All Students' Attendance Records</h2>
    <div id="allAttendanceRecords"></div>
    <div class="dashboard-links">
        <a id="backToDashboard" href="#">Back to Dashboard</a>
        <a id="logoutAllAttendance" href="#">Logout</a>
    </div>
</div>

<!-- Registration Page -->
<div class="container" id="registerContainer">
    <h2>Create Your Profile</h2>
    <form id="registerForm" autocomplete="off">
        <label for="fullName">Full Name <span style="color:red">*</span></label>
        <input type="text" id="regFullName" name="fullName" required autocomplete="off">

        <label for="regNumber">Registration Number <span style="color:red">*</span></label>
        <input type="text" id="regRegNumber" name="regNumber" required autocomplete="off">

        <label for="course">Course of Study <span style="color:red">*</span></label>
        <input type="text" id="regCourse" name="course" required autocomplete="off">

        <label for="fieldOfStudy">Field of Study <span style="color:red">*</span></label>
        <input type="text" id="regField" name="fieldOfStudy" required autocomplete="off">

        <label for="regPassword">Create Password <span style="color:red">*</span></label>
        <input type="password" id="regPassword" name="password" required minlength="6" autocomplete="new-password">

        <label for="regConfirmPassword">Confirm Password <span style="color:red">*</span></label>
        <input type="password" id="regConfirmPassword" name="confirmPassword" required minlength="6" autocomplete="new-password">

        <div class="error hidden" id="registerError"></div>
        <button type="submit">Create Profile</button>
        <div class="dashboard-links">
            Already have a profile? <a id="toLogin">Login</a>
        </div>
    </form>
</div>

<!-- Login Page -->
<div class="container hidden" id="loginContainer">
    <h2>Login</h2>
    <form id="loginForm" autocomplete="off">
        <label for="loginRegNumber">Registration Number <span style="color:red">*</span></label>
        <input type="text" id="loginRegNumber" name="loginRegNumber" required autocomplete="off">

        <label for="loginPassword">Password <span style="color:red">*</span></label>
        <input type="password" id="loginPassword" name="loginPassword" required autocomplete="current-password">

        <div class="error hidden" id="loginError"></div>
        <button type="submit">Login</button>
        <div class="dashboard-links" style="margin-top:12px;">
            <span>No profile? <a id="toRegister">Create one</a></span><br>
            <span><a id="toForgotPassword" style="color:#208b3a;">Forgot Password?</a></span>
        </div>
    </form>
</div>

<!-- Forgot Password Page -->
<div class="container hidden" id="forgotPasswordContainer">
    <h2>Reset Password</h2>
    <form id="forgotPasswordForm" autocomplete="off">
        <label for="fpRegNumber">Registration Number <span style="color:red">*</span></label>
        <input type="text" id="fpRegNumber" required autocomplete="off">

        <label for="fpLastAttendance">Last Day of Attendance (format: MM/DD/YYYY or DD/MM/YYYY) <span style="color:red">*</span></label>
        <input type="text" id="fpLastAttendance" placeholder="e.g., 09/17/2025" required autocomplete="off">

        <label for="fpNewPassword">New Password <span style="color:red">*</span></label>
        <input type="password" id="fpNewPassword" required minlength="6" autocomplete="new-password">

        <label for="fpConfirmPassword">Confirm New Password <span style="color:red">*</span></label>
        <input type="password" id="fpConfirmPassword" required minlength="6" autocomplete="new-password">

        <div class="error hidden" id="forgotPasswordError"></div>
        <div class="success hidden" id="forgotPasswordSuccess"></div>
        <button type="submit">Reset Password</button>
        <div class="dashboard-links">
            <a id="fpBackToLogin">Back to Login</a>
        </div>
    </form>
</div>

<!-- Dashboard Page -->
<div class="container hidden" id="dashboardContainer">
    <div class="profile-section">
        <img id="profilePhoto" class="profile-photo" src="https://ui-avatars.com/api/?name=User" alt="Profile Photo">
        <div class="profile-info-fields">
            <span style="font-size:1.3em;font-weight:bold;color:#134e1a;" id="userName"></span>
            <br>
            <span id="userCourse"></span> | 
            <span id="userField"></span>
            <br>
            <span style="font-size:.96em;color:#178a42;">Reg No: <span id="userReg"></span></span>
        </div>
        <button class="profile-edit-btn" id="editProfileBtn" title="Edit Profile">Edit</button>
    </div>
    <form class="profile-edit-form hidden" id="profileEditForm" enctype="multipart/form-data" autocomplete="off">
        <label for="editFullName">Full Name</label>
        <input type="text" id="editFullName" required>
        <label for="editCourse">Course of Study</label>
        <input type="text" id="editCourse" required>
        <label for="editField">Field of Study</label>
        <input type="text" id="editField" required>
        <label for="editProfilePhoto">Profile Photo</label>
        <input type="file" id="editProfilePhoto" accept="image/*">
        <div class="error hidden" id="editProfileError"></div>
        <button type="submit" style="background:#134e1a;color:#fff;">Save Changes</button>
        <button type="button" id="cancelEditProfile" style="background:#e9f5e1;color:#178a42;">Cancel</button>
    </form>
    <div class="dashboard-links">
        <a id="markAttendanceLink" href="#">Mark Attendance</a> | 
        <a id="viewAttendanceLink" href="#">My Attendance</a> | 
        <a id="viewAllAttendanceLink" href="#">All Attendance</a> | 
        <a id="viewProfilesLink" href="#">View Class Profiles</a> | 
        <a id="logoutBtn" href="#">Logout</a>
    </div>
    <div id="dashboardSection"></div>
</div>

<!-- User Profile Modal -->
<div class="modal-bg hidden" id="userProfileModalBg">
    <div class="modal-card" id="userProfileModalCard">
        <button class="modal-close-btn" id="closeUserProfileModal" title="Close">&times;</button>
        <div id="userProfileModalContent"></div>
    </div>
</div>

<!-- Print Section (hidden, used for print only) -->
<div id="attendancePrintSection" style="display:none;"></div>

<script>
    // Simulated "admin" credentials (still present if needed)
    const CLASS_MASTER_REG = "classmaster";
    const CLASS_MASTER_PASS = "master123";

    // Profile photo utility
    function readAndPreviewPhoto(file, callback) {
        if (!file) return callback('');
        const reader = new FileReader();
        reader.onload = function(e) {
            callback(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    // Registration
    const registerContainer = document.getElementById('registerContainer');
    const registerForm = document.getElementById('registerForm');
    const registerError = document.getElementById('registerError');
    const toLogin = document.getElementById('toLogin');

    toLogin.onclick = function() {
        registerContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        // All fields are required by HTML5, but we double-check for JS enforcement.
        const fullName = document.getElementById('regFullName').value.trim();
        const regNumber = document.getElementById('regRegNumber').value.trim();
        const course = document.getElementById('regCourse').value.trim();
        const field = document.getElementById('regField').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;

        if(!fullName || !regNumber || !course || !field || !password || !confirmPassword) {
            registerError.textContent = "All fields are required.";
            registerError.classList.remove('hidden');
            return;
        }

        if(password !== confirmPassword) {
            registerError.textContent = "Passwords do not match.";
            registerError.classList.remove('hidden');
            return;
        }
        if(password.length < 6) {
            registerError.textContent = "Password must be at least 6 characters.";
            registerError.classList.remove('hidden');
            return;
        }

        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        if(users[regNumber]) {
            registerError.textContent = "Registration number already exists.";
            registerError.classList.remove('hidden');
            return;
        }
        users[regNumber] = {
            fullName,
            regNumber,
            course,
            field,
            password,
            profilePhoto: "",
            attendance: []
        };
        localStorage.setItem('attendanceUsers', JSON.stringify(users));
        localStorage.setItem('attendanceCurrentUser', regNumber);

        registerForm.reset();
        showDashboard(users[regNumber]);
    });

    // Login
    const loginContainer = document.getElementById('loginContainer');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const toRegister = document.getElementById('toRegister');

    toRegister.onclick = function() {
        loginContainer.classList.add('hidden');
        registerContainer.classList.remove('hidden');
    };

    // Forgot Password
    const toForgotPassword = document.getElementById('toForgotPassword');
    const forgotPasswordContainer = document.getElementById('forgotPasswordContainer');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const fpBackToLogin = document.getElementById('fpBackToLogin');
    const forgotPasswordError = document.getElementById('forgotPasswordError');
    const forgotPasswordSuccess = document.getElementById('forgotPasswordSuccess');

    toForgotPassword.onclick = function() {
        loginContainer.classList.add('hidden');
        forgotPasswordContainer.classList.remove('hidden');
        forgotPasswordForm.reset();
        forgotPasswordError.classList.add('hidden');
        forgotPasswordSuccess.classList.add('hidden');
    };
    fpBackToLogin.onclick = function() {
        forgotPasswordContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    forgotPasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        forgotPasswordError.classList.add('hidden');
        forgotPasswordSuccess.classList.add('hidden');
        const regNumber = document.getElementById('fpRegNumber').value.trim();
        const lastAttendance = document.getElementById('fpLastAttendance').value.trim();
        const newPassword = document.getElementById('fpNewPassword').value;
        const confirmPassword = document.getElementById('fpConfirmPassword').value;

        if (!regNumber || !lastAttendance || !newPassword || !confirmPassword) {
            forgotPasswordError.textContent = "All fields are required.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        if (newPassword !== confirmPassword) {
            forgotPasswordError.textContent = "Passwords do not match.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        if (newPassword.length < 6) {
            forgotPasswordError.textContent = "Password must be at least 6 characters.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) {
            forgotPasswordError.textContent = "Registration number not found.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        if (!user.attendance || user.attendance.length === 0) {
            forgotPasswordError.textContent = "No attendance records found for this user.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        // Accept either MM/DD/YYYY or DD/MM/YYYY for flexibility, match either
        const lastAttendanceSanitized = lastAttendance.replace(/-/g, '/').replace(/\./g,'/').replace(/\s/g,''); // Remove spaces and unify separator
        const attendedDates = user.attendance.map(a => a.date.replace(/-/g, '/').replace(/\./g,'/').replace(/\s/g,''));
        const matched = attendedDates.some(d => d === lastAttendanceSanitized);
        if (!matched) {
            forgotPasswordError.textContent = "Last attendance date does not match our records.";
            forgotPasswordError.classList.remove('hidden');
            return;
        }
        user.password = newPassword;
        users[regNumber] = user;
        localStorage.setItem('attendanceUsers', JSON.stringify(users));
        forgotPasswordSuccess.textContent = "Password reset successful! You can now login with your new password.";
        forgotPasswordSuccess.classList.remove('hidden');
    });

    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const regNumber = document.getElementById('loginRegNumber').value.trim();
        const password = document.getElementById('loginPassword').value;

        // Admin login (kept, though not necessary for open attendance)
        if(regNumber === CLASS_MASTER_REG && password === CLASS_MASTER_PASS) {
            localStorage.setItem('attendanceCurrentUser', CLASS_MASTER_REG);
            showAllAttendance();
            return;
        }

        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        if(users[regNumber] && users[regNumber].password === password) {
            localStorage.setItem('attendanceCurrentUser', regNumber);
            showDashboard(users[regNumber]);
        } else {
            loginError.textContent = "Invalid registration number or password.";
            loginError.classList.remove('hidden');
        }
    });

    // Dashboard
    const dashboardContainer = document.getElementById('dashboardContainer');
    const userName = document.getElementById('userName');
    const userReg = document.getElementById('userReg');
    const userCourse = document.getElementById('userCourse');
    const userField = document.getElementById('userField');
    const profilePhoto = document.getElementById('profilePhoto');
    const dashboardSection = document.getElementById('dashboardSection');
    const markAttendanceLink = document.getElementById('markAttendanceLink');
    const viewAttendanceLink = document.getElementById('viewAttendanceLink');
    const viewAllAttendanceLink = document.getElementById('viewAllAttendanceLink');
    const viewProfilesLink = document.getElementById('viewProfilesLink');
    const logoutBtn = document.getElementById('logoutBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const profileEditForm = document.getElementById('profileEditForm');
    const editFullName = document.getElementById('editFullName');
    const editCourse = document.getElementById('editCourse');
    const editField = document.getElementById('editField');
    const editProfilePhoto = document.getElementById('editProfilePhoto');
    const editProfileError = document.getElementById('editProfileError');
    const cancelEditProfile = document.getElementById('cancelEditProfile');

    let currentProfilePhotoURL = "";

    function updateProfileUI(user) {
        userName.textContent = user.fullName;
        userReg.textContent = user.regNumber;
        userCourse.textContent = user.course;
        userField.textContent = user.field || '';
        // Handle photo
        let url = user.profilePhoto;
        if (url) {
            profilePhoto.src = url;
        } else {
            // fallback avatar with initials
            profilePhoto.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}`;
        }
    }

    markAttendanceLink.onclick = function() {
        dashboardSection.innerHTML = `
            <form id="attendanceForm">
                <button type="submit" id="markAttendanceBtn">Mark Attendance</button>
            </form>
            <div class="success hidden" id="attendanceSuccess">Attendance recorded successfully!</div>
            <div class="error hidden" id="attendanceError"></div>
        `;
        document.getElementById('attendanceForm').onsubmit = handleAttendance;
    };

    viewAttendanceLink.onclick = function() {
        showAttendanceTableForUser(localStorage.getItem('attendanceCurrentUser'), true);
    };

    viewAllAttendanceLink.onclick = function() {
        dashboardContainer.classList.add('hidden');
        showAllAttendance();
    };

    viewProfilesLink.onclick = function() {
        showProfilesList();
    };

    logoutBtn.onclick = function() {
        localStorage.removeItem('attendanceCurrentUser');
        dashboardContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    function handleAttendance(e) {
        e.preventDefault();
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        const attendanceSuccess = document.getElementById('attendanceSuccess');
        const attendanceError = document.getElementById('attendanceError');
        attendanceSuccess.classList.add('hidden');
        attendanceError.classList.add('hidden');

        if(user) {
            const now = new Date();
            const date = now.toLocaleDateString();
            // Check if attendance already marked today
            const alreadyMarked = user.attendance.some(entry => entry.date === date);
            if(alreadyMarked) {
                attendanceError.textContent = "You have already marked attendance for today.";
                attendanceError.classList.remove('hidden');
                return;
            }
            const time = now.toLocaleTimeString();
            user.attendance.push({ date, time });
            users[regNumber] = user;
            localStorage.setItem('attendanceUsers', JSON.stringify(users));
            attendanceSuccess.classList.remove('hidden');
        }
    }

    function showDashboard(user) {
        registerContainer.classList.add('hidden');
        loginContainer.classList.add('hidden');
        dashboardContainer.classList.remove('hidden');
        allAttendanceContainer.classList.add('hidden');
        profileEditForm.classList.add('hidden');
        updateProfileUI(user);
        dashboardSection.innerHTML = '';
    }

    // Profile Edit
    editProfileBtn.onclick = function() {
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) return;
        editFullName.value = user.fullName;
        editCourse.value = user.course;
        editField.value = user.field;
        currentProfilePhotoURL = user.profilePhoto || "";
        profileEditForm.classList.remove('hidden');
    };

    cancelEditProfile.onclick = function() {
        profileEditForm.classList.add('hidden');
        editProfileError.classList.add('hidden');
    };

    profileEditForm.onsubmit = function(e) {
        e.preventDefault();
        editProfileError.classList.add('hidden');
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) return;
        const newFullName = editFullName.value.trim();
        const newCourse = editCourse.value.trim();
        const newField = editField.value.trim();
        if (!newFullName || !newCourse || !newField) {
            editProfileError.textContent = "All fields are required.";
            editProfileError.classList.remove('hidden');
            return;
        }
        // Handle photo upload
        const file = editProfilePhoto.files[0];
        if (file) {
            if (file.size > 1024 * 1024) {
                editProfileError.textContent = "Profile photo must be less than 1MB.";
                editProfileError.classList.remove('hidden');
                return;
            }
            readAndPreviewPhoto(file, function(dataUrl) {
                user.profilePhoto = dataUrl;
                finishProfileEditUpdate();
            });
        } else {
            user.profilePhoto = currentProfilePhotoURL;
            finishProfileEditUpdate();
        }
        function finishProfileEditUpdate() {
            user.fullName = newFullName;
            user.course = newCourse;
            user.field = newField;
            users[regNumber] = user;
            localStorage.setItem('attendanceUsers', JSON.stringify(users));
            profileEditForm.classList.add('hidden');
            updateProfileUI(user);
        }
    };

    // All Attendance (Visible to Everyone)
    const allAttendanceContainer = document.getElementById('allAttendanceContainer');
    const allAttendanceRecords = document.getElementById('allAttendanceRecords');
    const backToDashboard = document.getElementById('backToDashboard');
    const logoutAllAttendance = document.getElementById('logoutAllAttendance');

    backToDashboard.onclick = function() {
        const regNumber = localStorage.getItem('attendanceCurrentUser');
        if (regNumber && regNumber !== CLASS_MASTER_REG) {
            const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
            showDashboard(users[regNumber]);
        } else {
            allAttendanceContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
        }
    };

    logoutAllAttendance.onclick = function() {
        localStorage.removeItem('attendanceCurrentUser');
        allAttendanceContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
    };

    function showAllAttendance() {
        registerContainer.classList.add('hidden');
        loginContainer.classList.add('hidden');
        dashboardContainer.classList.add('hidden');
        allAttendanceContainer.classList.remove('hidden');

        // Show all attendance records for all students, with profile view buttons
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        let html = '';
        let hasAttendance = false;
        for(const reg in users) {
            const user = users[reg];
            let img = user.profilePhoto
                ? `<img src="${user.profilePhoto}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;vertical-align:middle;margin-right:10px;border:1.5px solid #208b3a;">`
                : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;vertical-align:middle;margin-right:10px;border:1.5px solid #208b3a;">`;
            html += `<div class="admin-section">
                ${img}
                <strong style="vertical-align:middle;">${user.fullName} (${user.regNumber})</strong>
                <button class="user-profile-btn" data-reg="${user.regNumber}" title="View Profile">Profile</button><br>
                <em>Course: ${user.course} <br>Field: ${user.field || ''}</em>
                <button class="print-btn" data-print-reg="${user.regNumber}" title="Print Attendance">Print</button>
                <table class="attendance-table" style="margin-top:10px;">
                    <tr><th>#</th><th>Date</th><th>Time</th></tr>
                    ${
                        user.attendance && user.attendance.length > 0 ?
                        user.attendance.map((a,i) => `
                            <tr>
                                <td>${i+1}</td>
                                <td>${a.date}</td>
                                <td>${a.time}</td>
                            </tr>
                        `).join('') :
                        '<tr><td colspan="3">No attendance records.</td></tr>'
                    }
                </table>
            </div>`;
            if (user.attendance && user.attendance.length > 0) hasAttendance = true;
        }
        if(!hasAttendance) html = "<p>No attendance records yet.</p>";
        allAttendanceRecords.innerHTML = html;

        // Attach event listeners for "Profile" and "Print" buttons
        document.querySelectorAll('.user-profile-btn').forEach(btn => {
            btn.onclick = function() {
                const reg = btn.getAttribute('data-reg');
                showUserProfileModal(reg);
            };
        });
        document.querySelectorAll('.print-btn').forEach(btn => {
            btn.onclick = function() {
                const reg = btn.getAttribute('data-print-reg');
                printAttendanceReport(reg);
            };
        });
    }

    // Show "My Attendance" in dashboard, with print button
    function showAttendanceTableForUser(regNumber, showPrintBtn) {
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if(user) {
            let table = `<h3>My Attendance</h3>
                ${showPrintBtn ? `<button class="print-btn" id="printMyAttendanceBtn" style="float:right;">Print</button>` : ''}
                <table class="attendance-table">
                <tr><th>#</th><th>Date</th><th>Time</th></tr>`;
            if(user.attendance.length === 0) {
                table += "<tr><td colspan='3'>No attendance records.</td></tr>";
            } else {
                user.attendance.forEach((a, i) => {
                    table += `<tr>
                        <td>${i+1}</td>
                        <td>${a.date}</td>
                        <td>${a.time}</td>
                    </tr>`;
                });
            }
            table += "</table>";
            dashboardSection.innerHTML = table;
            if (showPrintBtn) {
                document.getElementById('printMyAttendanceBtn').onclick = function() {
                    printAttendanceReport(regNumber);
                };
            }
        }
    }

    // Show all profiles with buttons to view attendance
    function showProfilesList() {
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        let html = `<h3>Class Profiles</h3>`;
        html += `<table class="attendance-table" style="margin-bottom:20px;">
            <tr>
                <th>Photo</th>
                <th>Full Name</th>
                <th>Reg No</th>
                <th>Course</th>
                <th>Field</th>
                <th>Profile</th>
                <th>Attendance</th>
            </tr>`;
        let any = false;
        for(const reg in users) {
            const user = users[reg];
            let img = user.profilePhoto
                ? `<img src="${user.profilePhoto}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;border:1.5px solid #208b3a;">`
                : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;border:1.5px solid #208b3a;">`;
            html += `<tr>
                <td>${img}</td>
                <td>${user.fullName}</td>
                <td>${user.regNumber}</td>
                <td>${user.course}</td>
                <td>${user.field || ''}</td>
                <td><button class="user-profile-btn" data-reg="${user.regNumber}" title="View Profile">Profile</button></td>
                <td><button class="user-attendance-btn" data-reg="${user.regNumber}" title="View Attendance">Attendance</button></td>
            </tr>`;
            any = true;
        }
        if (!any) {
            html += `<tr><td colspan="7">No profiles found.</td></tr>`;
        }
        html += `</table>`;
        dashboardSection.innerHTML = html;

        // Attach event listeners for each profile and attendance button
        document.querySelectorAll('.user-profile-btn').forEach(btn => {
            btn.onclick = function() {
                const reg = btn.getAttribute('data-reg');
                showUserProfileModal(reg);
            };
        });
        document.querySelectorAll('.user-attendance-btn').forEach(btn => {
            btn.onclick = function() {
                const reg = btn.getAttribute('data-reg');
                showOtherAttendanceTable(reg);
            };
        });
    }

    // Show another user's attendance table in the dashboard, with print
    function showOtherAttendanceTable(regNumber) {
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if(user) {
            let table = `<h3>${user.fullName}'s Attendance</h3>
                <button class="print-btn" id="printOtherAttendanceBtn" style="float:right;">Print</button>
                <table class="attendance-table">
                <tr><th>#</th><th>Date</th><th>Time</th></tr>`;
            if(user.attendance.length === 0) {
                table += "<tr><td colspan='3'>No attendance records.</td></tr>";
            } else {
                user.attendance.forEach((a, i) => {
                    table += `<tr>
                        <td>${i+1}</td>
                        <td>${a.date}</td>
                        <td>${a.time}</td>
                    </tr>`;
                });
            }
            table += "</table>";
            dashboardSection.innerHTML = table;
            document.getElementById('printOtherAttendanceBtn').onclick = function() {
                printAttendanceReport(regNumber);
            };
        }
    }

    // User Profile Modal
    const userProfileModalBg = document.getElementById('userProfileModalBg');
    const userProfileModalCard = document.getElementById('userProfileModalCard');
    const userProfileModalContent = document.getElementById('userProfileModalContent');
    const closeUserProfileModal = document.getElementById('closeUserProfileModal');
    closeUserProfileModal.onclick = function() {
        userProfileModalBg.classList.add('hidden');
    };
    userProfileModalBg.onclick = function(e) {
        if (e.target === userProfileModalBg) userProfileModalBg.classList.add('hidden');
    };
    function showUserProfileModal(regNumber) {
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (user) {
            let img = user.profilePhoto
                ? `<img class="modal-profile-photo" src="${user.profilePhoto}" alt="Profile Photo">`
                : `<img class="modal-profile-photo" src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}" alt="Profile Photo">`;
            userProfileModalContent.innerHTML = `
                <div style="text-align:center;">
                    ${img}
                    <div style="font-weight:bold;font-size:1.15em;color:#134e1a;">${user.fullName}</div>
                    <div style="color:#178a42;margin-bottom:6px;">Reg No: ${user.regNumber}</div>
                    <div style="margin-bottom:5px;">Course: ${user.course}<br>Field: ${user.field || ''}</div>
                    <div><strong>Total Attendance:</strong> ${user.attendance ? user.attendance.length : 0}</div>
                </div>
            `;
            userProfileModalBg.classList.remove('hidden');
        }
    }

    // Print Attendance Report for a given user
    function printAttendanceReport(regNumber) {
        const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
        const user = users[regNumber];
        if (!user) return;
        let img = user.profilePhoto
            ? `<img src="${user.profilePhoto}" style="width:60px;height:60px;object-fit:cover;border-radius:50%;border:2px solid #208b3a;margin-bottom:10px;background:#eafaea;">`
            : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}" style="width:60px;height:60px;object-fit:cover;border-radius:50%;border:2px solid #208b3a;margin-bottom:10px;background:#eafaea;">`;
        let html = `
            <div style="text-align:center;margin-bottom:20px;">
                <h2 style="color:#134e1a;">Attendance Report</h2>
                ${img}
                <div style="font-weight:bold;font-size:1.13em;">${user.fullName} (${user.regNumber})</div>
                <div style="margin:2px 0 5px 0;">Course: ${user.course} | Field: ${user.field || ""}</div>
                <div><b>Total Attendance:</b> ${user.attendance ? user.attendance.length : 0}</div>
            </div>
            <table class="attendance-table" style="width:100%;margin:auto;">
                <tr><th>#</th><th>Date</th><th>Time</th></tr>
                ${user.attendance && user.attendance.length > 0 
                    ? user.attendance.map((a,i) => `
                        <tr>
                            <td>${i+1}</td>
                            <td>${a.date}</td>
                            <td>${a.time}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="3">No attendance records.</td></tr>'
                }
            </table>
        `;
        const printDiv = document.getElementById('attendancePrintSection');
        printDiv.innerHTML = html;
        printDiv.style.display = 'block';
        window.print();
        setTimeout(() => { printDiv.innerHTML = ''; printDiv.style.display = 'none'; }, 500);
    }

    // On Load
    window.onload = function() {
        const currentUser = localStorage.getItem('attendanceCurrentUser');
        if(currentUser === CLASS_MASTER_REG) {
            showAllAttendance();
        } else if(currentUser) {
            const users = JSON.parse(localStorage.getItem('attendanceUsers') || '{}');
            if(users[currentUser]) {
                showDashboard(users[currentUser]);
            } else {
                localStorage.removeItem('attendanceCurrentUser');
                registerContainer.classList.remove('hidden');
            }
        } else {
            registerContainer.classList.remove('hidden');
        }
    };
</script>
</body>
</html>
